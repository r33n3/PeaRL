# PeaRL — AI Development Conventions

This file guides Claude Code and other AI assistants working in this repo.

## Project Overview

PeaRL is an API-first risk orchestration platform. It enforces governance gates between AI agents and production deployments.

- **Backend**: FastAPI + SQLAlchemy async + PostgreSQL/SQLite
- **Frontend**: React + TypeScript + Vite
- **Workers**: Redis-backed async job queue
- **Auth**: JWT (HS256 local, RS256 prod) + API key support

## ID Prefixes

Every entity has a prefixed ID generated by `generate_id(prefix)`:

| Entity | Prefix | Example |
|--------|--------|---------|
| Project | `proj_` | `proj_abc123` |
| Job | `job_` | `job_xyz789` |
| Finding | `find_` | `find_def456` |
| TaskPacket | `tp_` | `tp_ghi012` |
| Approval | `appr_` | `appr_jkl345` |
| Exception | `exc_` | `exc_mno678` |
| Report | `rpt_` | `rpt_pqr901` |
| RemediationSpec | `rem_` | `rem_stu234` |
| User | `usr_` | `usr_vwx567` |
| ApiKey | `key_` | `key_yza890` |
| Org | `org_` | `org_bcd123` |

## Architecture Patterns

### Repository Pattern
All DB access goes through repositories in `src/pearl/repositories/`. Never write raw SQL in routes.

```python
# Correct
repo = FindingRepository(session)
findings = await repo.list_by_field("project_id", project_id)

# Incorrect — direct query in route
result = await session.execute(select(FindingRow).where(...))
```

### Worker Pattern
Background jobs extend `BaseWorker`. Register new workers in `src/pearl/workers/registry.py`.

```python
class MyWorker(BaseWorker):
    async def process(self, job_id: str, payload: dict, session: AsyncSession) -> dict:
        # Do work
        return {"result_refs": [...]}
```

### Route Structure
- Routes live in `src/pearl/api/routes/`
- Use `Depends(get_db)` for database sessions
- Use `Depends(get_current_user)` for authenticated user
- Use `Depends(require_role("admin"))` for role-gated endpoints
- Return plain dicts (not Pydantic models) from routes when serializing ORM rows

### Error Handling
Use custom exceptions from `src/pearl/errors/exceptions.py`:
- `NotFoundError(resource, id)` → 404
- `ValidationError(message)` → 400
- `AuthenticationError(message)` → 401
- `AuthorizationError(message)` → 403
- `ConflictError(message)` → 409

## Auth

**Local dev** (`PEARL_LOCAL=1`): No real auth. All requests pass through.

**Production**: JWT Bearer tokens or `X-API-Key` header. Roles: `viewer`, `operator`, `admin`, `service_account`.

## Testing

```bash
PEARL_LOCAL=1 pytest tests/ -v
```

Tests use SQLite in-memory DB (via `PEARL_LOCAL=1`). No external services needed for unit tests.

Contract tests in `tests/contract/` validate API behavior against OpenAPI spec.

## Environment Hierarchy

dev → pilot → preprod → prod (each has its own approval level)

## Key Files

| File | Purpose |
|------|---------|
| `src/pearl/main.py` | App factory, lifespan, middleware |
| `src/pearl/config.py` | All settings (PEARL_ env vars) |
| `src/pearl/api/router.py` | Master router (/api/v1) |
| `src/pearl/api/middleware/auth.py` | JWT + API key validation |
| `src/pearl/workers/registry.py` | Job type → worker mapping |
| `src/pearl/workers/scheduler.py` | Periodic scan scheduler |
| `src/pearl/api/routes/stream.py` | SSE real-time events |

## Do Not

- Don't commit secrets to `.env` (use `.env.example` only)
- Don't write raw SQL in route handlers
- Don't call `session.commit()` inside a repository method (commit in routes)
- Don't add workers without registering in `registry.py`
- Don't modify `PEARL_spec/` OpenAPI spec without updating corresponding routes

## Governance Constraints (Agent-Enforced)

These rules apply to ALL AI agents (Claude Code and others) operating in this codebase:

- **Do NOT read, write, or modify `.env` or any server configuration file.** Configuration is managed by humans only.
- **Do NOT ask users to add, remove, or change environment variables** (e.g., `PEARL_LOCAL_REVIEWER`, `PEARL_LOCAL`, or any other flag). If a governance action requires elevated privileges, use `pearl_request_approval` to submit it for human review.
- **Do NOT call `/openapi.json`, `/docs`, or `/redoc`** to discover API endpoint schemas. Use only the MCP tools provided.
- **Do NOT attempt to approve your own exceptions or approvals** — directly, via curl, via MCP, or by asking the user to enable elevated privileges on your behalf.
- **Do NOT restart server processes** (`docker compose restart`, `uvicorn`, `systemctl`, `kill`, `pkill`, etc.).
- **Do NOT enumerate running processes** (`ps aux`, `pgrep`, `lsof`, etc.) to find or target server processes.
- If a governance gate is blocking you, the correct response is: call `pearl_request_approval` or `pearl_create_exception`, inform the user, and stop. Do not attempt to route around the gate.
