{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://pearl.local/schemas/context/compiled-context-package.schema.json",
  "title": "CompiledContextPackage",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "$ref": "../common/common-defs.schema.json#/$defs/schema_version"
    },
    "kind": {
      "const": "PearlCompiledContextPackage"
    },
    "package_metadata": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "package_id": {
          "type": "string",
          "pattern": "^pkg_[A-Za-z0-9_-]+$"
        },
        "compiled_from": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "org_baseline_id": {
              "type": "string"
            },
            "app_spec_id": {
              "type": "string"
            },
            "environment_profile_id": {
              "type": "string"
            },
            "remediation_overlay_id": {
              "type": [
                "string",
                "null"
              ]
            }
          },
          "required": [
            "org_baseline_id",
            "app_spec_id",
            "environment_profile_id"
          ]
        },
        "integrity": {
          "$ref": "../common/common-defs.schema.json#/$defs/integrity"
        },
        "compiler_version": {
          "type": "string"
        },
        "merge_precedence_version": {
          "type": "string"
        }
      },
      "required": [
        "package_id",
        "compiled_from",
        "integrity"
      ]
    },
    "project_identity": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "project_id": {
          "type": "string"
        },
        "app_id": {
          "type": "string"
        },
        "environment": {
          "$ref": "../common/common-defs.schema.json#/$defs/environment"
        },
        "delivery_stage": {
          "$ref": "../common/common-defs.schema.json#/$defs/delivery_stage"
        },
        "ai_enabled": {
          "type": "boolean"
        }
      },
      "required": [
        "project_id",
        "environment",
        "ai_enabled"
      ]
    },
    "environment_profile": {
      "type": "object",
      "additionalProperties": true
    },
    "autonomy_policy": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "$ref": "../common/common-defs.schema.json#/$defs/autonomy_mode"
        },
        "allowed_actions": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "blocked_actions": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "approval_required_for": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "mode",
        "allowed_actions",
        "blocked_actions"
      ]
    },
    "security_requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "required_controls": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "prohibited_patterns": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "required_controls"
      ]
    },
    "responsible_ai_requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "transparency": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "ai_disclosure_required": {
              "type": "boolean"
            },
            "model_provenance_logging_required": {
              "type": "boolean"
            },
            "explanation_metadata_required": {
              "type": "string",
              "enum": [
                "none",
                "basic",
                "enhanced"
              ]
            }
          }
        },
        "fairness": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "review_required": {
              "type": "boolean"
            },
            "monitoring_required": {
              "type": "boolean"
            }
          }
        },
        "oversight": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "human_review_required_for": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "iam_requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "least_privilege_required": {
          "type": "boolean"
        }
      }
    },
    "network_requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "outbound_allowlist": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "public_egress_forbidden": {
          "type": "boolean"
        }
      }
    },
    "data_handling_requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "prohibited_in_model_context": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "tool_and_model_constraints": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "allowed_tool_classes": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "forbidden_tool_classes": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "allowed_model_tiers": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "forbidden_model_tiers": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "required_tests": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "security": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "rai": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "functional": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "approval_checkpoints": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "checkpoint_id": {
            "type": "string"
          },
          "trigger": {
            "type": "string"
          },
          "required_roles": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "environment": {
            "$ref": "../common/common-defs.schema.json#/$defs/environment"
          }
        },
        "required": [
          "checkpoint_id",
          "trigger"
        ]
      }
    },
    "evidence_requirements": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "change_reassessment_triggers": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "architecture_delta": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "autonomous_remediation_eligibility": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "default": {
          "type": "string",
          "enum": [
            "auto_allowed",
            "auto_allowed_with_approval",
            "human_required",
            "not_autonomous"
          ]
        },
        "rules": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "match": {
                "type": "string"
              },
              "eligibility": {
                "type": "string",
                "enum": [
                  "auto_allowed",
                  "auto_allowed_with_approval",
                  "human_required",
                  "not_autonomous"
                ]
              }
            },
            "required": [
              "match",
              "eligibility"
            ]
          }
        }
      }
    },
    "exceptions": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "traceability": {
      "$ref": "../common/common-defs.schema.json#/$defs/traceability_ref"
    },
    "references": {
      "type": "array",
      "items": {
        "$ref": "../common/common-defs.schema.json#/$defs/reference"
      }
    }
  },
  "required": [
    "schema_version",
    "kind",
    "package_metadata",
    "project_identity",
    "autonomy_policy",
    "security_requirements"
  ]
}
